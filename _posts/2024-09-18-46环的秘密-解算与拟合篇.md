---
title: 46 环的秘密—解算与拟合篇
data: 2024-09-18 15:38:44 +0800
categories: [RoboMaster, 能量机关]
tags: [RoboMaster, 坐标变换, 最小二乘拟合, 能量机关]
math: true
description: 能量机关解算与拟合算法详解
author: zmsbruce
---

![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/cover.png)

书接上文，在得到特征点之后，我们便可以拿到其像素坐标。接下来，我们进行一系列解算，得到连续的角度信息，角度信息进而被拿来进行拟合，得到大能量机关的旋转参数。

# 角度解算

首先，根据特征点的像素坐标和其对应的世界坐标进行 PnP 解算，得到 $$3\times 1$$ 的旋转向量和平移向量，再将其转为 $$4\times 4$$ 的，将世界坐标系转换为相机坐标系的变换矩阵 $$T_1$$.

> 关于 PnP 解算的方法，经过实验得出，选择**迭代法**会比其他方法得到更准确且稳定的结果。
{: .prompt-tip}

相机到云台的坐标系变换矩阵 $$T_2$$ 由先验参数得到（可以用尺子测量或者找机械的同学在 SolidWorks 中得到），而云台到车身的坐标变换 $$T_3$$ 则根据当前车身的 roll, pitch 和 yaw 获得。最终，我们得到了世界坐标系转车身坐标系的变换矩阵 $$T$$ 为：

$$
T=T_3\times T_2\times T_1
$$

那么该变换矩阵对应的旋转矩阵为：

$$
R=T_{0,0}(3,3)
$$

> 有关世界到相机、相机到云台、云台到车身的坐标系如下图所示：
{: .prompt-info}

![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/coor.png)
_不同的坐标系_

我们将第一次识别到大能量机关的旋转矩阵记录下来，记为 $$R_0$$. 我们设当前为第 $$i$$ 帧，接下来，根据第 $$i$$ 帧得到的旋转矩阵 $$R$$ 和 $$R_0$$ 进行运算，得到第 $$i$$ 帧相对于第一帧的旋转矩阵 $$R_r$$：

$$
R_r=R_0^{-1}R
$$

之后我们可以求得第 $$i$$ 帧相对于第一帧的旋转角度 $$\alpha_t$$ 为：

$$
\alpha_t=\arctan\frac{R_r(0,1)}{R_r(0,0)}
$$

至此我们进行了初步的角度解算，但这并没有结束，因为能量机关装甲板切换会造成刚刚求得的角度不连续，而我们需要一段连续的角度进行拟合。因此我们需要将第 $$i-1$$ 帧的旋转角度和第 $$i$$ 帧进行做差，并除以两片扇叶之间的夹角 $$\gamma$$，得到装甲板切换数 $$n_i$$：

$$
n_i=\text{round}(\frac{\alpha_t}{\gamma})
$$

将 $$n_i$$ 与历史装甲板切换数进行相加，得到总的装甲板切换数 $$n$$：

$$
n=\sum_{m=0}^{i}n_m
$$

我们之后再将刚刚得到的角度 $$\alpha_t$$ 减去总装甲板切换数 $$n$$ 乘以两片扇叶之间的夹角 $$\gamma$$，即可得到连续的角度 $$\alpha_r$$：

$$
\alpha_r=\alpha_t-n\cdot\gamma
$$

至此，我们完成了角度的解算。我们将当前相对于第一帧的时间间隔与角度 $$\alpha_r$$ 存储起来，进行后续的拟合操作。

> 由于装甲板切换需要利用到历史数据，如果当前出现了误识别得到了错误的角度，那么其很有可能对未来一段时间的角度解算都产生不利的影响。因此需要保持**严格的识别策略**，宁可识别失败也不要出现误识别的情况。
{: .prompt-warning}

# 拟合

TODO
