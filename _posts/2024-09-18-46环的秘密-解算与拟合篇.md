---
title: 46 环的秘密—解算与拟合篇
data: 2024-09-18 15:38:44 +0800
categories: [RoboMaster, 能量机关]
tags: [RoboMaster, 坐标变换, 最小二乘拟合, 能量机关]
math: true
description: 能量机关解算与拟合算法详解
author: zmsbruce
---

![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/cover.png)

书接上文，在得到特征点之后，我们便可以拿到其像素坐标。接下来，我们进行一系列解算，得到连续的角度信息，角度信息进而被拿来进行拟合，得到大能量机关的旋转参数。

## 角度解算

首先，根据特征点的像素坐标和其对应的世界坐标进行 PnP 解算，得到 $$3\times 1$$ 的旋转向量和平移向量，再将其转为 $$4\times 4$$ 的，将世界坐标系转换为相机坐标系的变换矩阵 $$T_{w2c}$$.

> 关于 PnP 解算的方法，经过实验得出，选择**迭代法**会比其他方法得到更准确且稳定的结果。
{: .prompt-tip}

相机到云台的坐标系变换矩阵 $$T_{c2g}$$ 由先验参数得到（可以用尺子测量或者找机械的同学在 SolidWorks 中得到），而云台到车身的坐标变换 $$T_{g2r}$$ 则根据当前车身的 roll, pitch 和 yaw 获得。最终，我们得到了世界坐标系转车身坐标系的变换矩阵 $$T_{w2r}$$ 为：

$$
T_{w2r}=T_{g2r}\times T_{c2g}\times T_{w2c}
$$

那么该变换矩阵对应的旋转矩阵为：

$$
R=T_{w2r\ (0,0)}(3,3)
$$

> 有关世界到相机、相机到云台、云台到车身的坐标系如下图所示：
{: .prompt-info}

![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/coor.png)
_不同的坐标系_

我们将第一次识别到大能量机关的旋转矩阵记录下来，记为 $$R_0$$. 我们设当前为第 $$i$$ 帧，接下来，根据第 $$i$$ 帧得到的旋转矩阵 $$R$$ 和 $$R_0$$ 进行运算，得到第 $$i$$ 帧相对于第一帧的旋转矩阵 $$R_r$$：

$$
R_r=R_0^{-1}R
$$

之后我们可以求得第 $$i$$ 帧相对于第一帧的旋转角度 $$\alpha_t$$ 为：

$$
\alpha_t=\arctan\frac{R_r(0,1)}{R_r(0,0)}
$$

至此我们进行了初步的角度解算，但这并没有结束，因为能量机关装甲板切换会造成刚刚求得的角度不连续，而我们需要一段连续的角度进行拟合。因此我们需要将第 $$i-1$$ 帧的旋转角度和第 $$i$$ 帧进行做差，并除以两片扇叶之间的夹角 $$\gamma$$，得到装甲板切换数 $$n_i$$：

$$
n_i=\text{round}(\frac{\alpha_t}{\gamma})
$$

将 $$n_i$$ 与历史装甲板切换数进行相加，得到总的装甲板切换数 $$n$$：

$$
n=\sum_{m=0}^{i}n_m
$$

我们之后再将刚刚得到的角度 $$\alpha_t$$ 减去总装甲板切换数 $$n$$ 乘以两片扇叶之间的夹角 $$\gamma$$，即可得到连续的角度 $$\alpha_r$$：

$$
\alpha_r=\alpha_t-n\cdot\gamma
$$

至此，我们完成了角度的解算。我们将当前相对于第一帧的时间间隔与角度 $$\alpha_r$$ 存储起来，进行后续的拟合操作。

> 由于装甲板切换需要利用到历史数据，如果当前出现了误识别得到了错误的角度，那么其很有可能对未来一段时间的角度解算都产生不利的影响。因此需要保持**严格的识别策略**，宁可识别失败也不要出现误识别的情况。
{: .prompt-warning}

## 拟合

从[规则手册](https://terra-1-g.djicdn.com/b2a076471c6c4b72b574a977334d3e05/RM2024/RoboMaster%202024%20%E6%9C%BA%E7%94%B2%E5%A4%A7%E5%B8%88%E8%B6%85%E7%BA%A7%E5%AF%B9%E6%8A%97%E8%B5%9B%E6%AF%94%E8%B5%9B%E8%A7%84%E5%88%99%E6%89%8B%E5%86%8CV2.1%EF%BC%8820240722%EF%BC%89.pdf)得知，大能量机关转速按照三角函数呈周期性变化。速度目标函数为：

$$
\text{spd}(t)=a\cdot\sin(\omega\cdot t)+b
$$

我们需要将其转化为角度和时间的函数。我们对上面的公式做积分，可得：

$$
\text{angle}(t)=\int\text{spd(t)}\, dt=-\frac{a}{\omega}\cos(\omega t+t_0)+b\cdot t+c
$$

综上，我们需要拟合 $$a,\omega,t_0,b,c$$ 这五个参数。然而，目前我们还未对参数设置任何限制，因此可能出现一种情况：尽管模型对历史数据的拟合表现不错，但对未来数据的预测却存在较大误差，具体示例如下图所示：

![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/no_constraint.png)
_没有约束的拟合效果_

好在[规则手册](https://terra-1-g.djicdn.com/b2a076471c6c4b72b574a977334d3e05/RM2024/RoboMaster%202024%20%E6%9C%BA%E7%94%B2%E5%A4%A7%E5%B8%88%E8%B6%85%E7%BA%A7%E5%AF%B9%E6%8A%97%E8%B5%9B%E6%AF%94%E8%B5%9B%E8%A7%84%E5%88%99%E6%89%8B%E5%86%8CV2.1%EF%BC%8820240722%EF%BC%89.pdf)中提供了各个参数的约束范围：

$$
0.780\leq a\leq 1.045,\ 1.884\leq\omega\leq 2.000,\ b=2.090-a
$$

直接为参数设置硬性的上下界虽然可以确保参数值的合理性，但这种方法会显著减慢拟合的速度。因此我们采用了一种**惩罚策略**，首先将所有参数初始化为其允许范围的**平均值**，在每次拟合过程中，将每个参数的变化量（即与初始值的绝对差值）乘以一定的权重加入损失函数，作为额外的惩罚项，这样可以允许参数在没有严格边界约束的情况下自由变化，同时通过损失函数中的惩罚项来阻止参数偏离其合理范围过远。

> 惩罚项参数的权重是一种**超参数**，需要人工设定。可以根据比赛数据，以平均 0.3s （24m/s 弹速下，子弹发射到击打到能量机关的时间）后误差最小为目标对其进行设定与调优。
{: .prompt-tip}

添加了惩罚项的拟合函数对之前有较大误差的预测会有所改善，如下图所示，其 0.3s 后的误差由 0.38 下降到了 0.075：

![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/with_constriant.png)
_带有约束的拟合效果_

对于一场[比赛数据](/assets/files/2024-05-25-09-51-16.csv)而言，添加了惩罚项的拟合函数使得平均误差由 0.057 降低到了 0.035.

> 有关误差角度和环数的联系，请见上一篇文章。
{: .prompt-tip}

> 在 2022 年及以前的能量机关策略中，一方激活能量机关后，另一方不可激活，因此对激活速度具有较高的要求，在点数大于 40 个时（0.2s）便允许进行击打。因此在点数为 40 到 100 个时（0.2s~0.5s），还会增加一项凹凸性判断来约束参数 $$t_0$$，以避免得到错误的拟合参数。不过随着这项规则的取消，为了追求准确度，一般在点数为 200（1s）及以上才允许击打，凹凸性判断便不再必要。
{: .prompt-info}

对于输入数据而言，其长度以每秒 200 的速度增加，如果将其全部带入最小二乘拟合中，其处理时间将越来越长。且其中的误识别带来的噪点也会对拟合结果造成影响。为了解决这个问题，我们在点的数量大于一定程度时启用一种类似 RANSAC 的算法，每次取部分点带入拟合，对剩余的点进行内点外点的判断。然而与 RANSAC 不同的是，我们每次只对内点取点进行拟合，而不是所有点；内点中不符合要求的点会被移到外点中，而之前外点如果符合此次拟合结果要求，又会移动到内点中。在一定的迭代次数后，我们取最后一次的拟合结果为最终结果。

## 角度获取和位置预测

要获得从当前帧到弹丸击打到能量机关的旋转角度，首先我们要知道子弹从发射到命中的时间间隔。由于世界转车身坐标系的变换矩阵已知，我们可以求得车身到圆靶中心的距离为 $$s=\|T(:,3)\|$$ 。而上一次弹丸发射速度 $$v_p$$ 可以通过裁判系统得到，假设弹速稳定，那么可以求得时间间隔为

$$
t_0=\frac{s}{v_p}=\frac{\|T_{w2c}(:,3)\|}{v_p}
$$

对于小能量机关，其旋转速度 $$v_s$$ 是固定的 $$1/3\pi \text{rad/s}$$。那么旋转角度 $$\text{rot}_s$$ 可以求得：

$$
\text{rot}_s=v_s\cdot t_0=v_s\cdot\frac{\|T_{w2r}(:,3)\|}{v_p}
$$

而对于大能量机关，设当前相对于第一次识别的时间间隔为 $$t$$，则其旋转角度 $$\text{rot}_l$$ 可以由之前的公式求得：

$$
\text{rot}_l=\text{angle}(t+t_0)-\text{angle}(t)
$$

在获取到旋转角度后，设能量机关旋转半径为 $$R$$，我们可以求得其对应的世界坐标系 $$4\times 1$$ 的坐标向量为：

$$
\text{coor}_w=[R\sin(\text{rot}),R\cos(\text{rot}),0,1]
$$

我们将其转为车身坐标系：

$$
\text{coor}_r=T_{w2r}\cdot\text{coor}_w
$$

之后便可以将其转化为一个斜抛问题，如下图所示：

![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/motion_light.png){: .light }{: w="250" h="200" }
![](/assets/img/2024-09-18-46环的秘密-解算与拟合篇/motion_dark.png){: .dark }{: w="250" h="200" }

设目标的位置为 $$(x,y,z)$$ ，那么弹丸到目标的直线水平距离 $$r$$ 为：

$$
r=\sqrt{x^2+z^2}
$$

子弹的水平速度可以通过总速度 $$v$$ 和发射角度 $$\text{pitch}$$ 计算：

$$
v_x=v\cdot\cos(\text{pitch})
$$

利用水平距离和水平速度，我们可以得出弹丸到达目标需要的时间 $$t$$ 为：

$$
t=\frac{r}{v\cdot\cos(\text{pitch})}
$$

将 $$t$$ 代入运动方程，我们得到：

$$
y=v_yt-\frac{1}{2}gt^2=v\cdot\sin(\text{pitch})-\frac{1}{2}g(\frac{r}{v\cdot\cos(\text{pitch})})^2
$$

整理为二次方程，我们得到

$$
\frac{g\cdot r^2}{2v^2}\cdot\frac{1}{\cos^2(\text{pitch})}+r\cdot\tan(\text{pitch})-y=0
$$

由此即可求得 pitch 为二次方程的正数项. 对于 yaw，则有

$$
\tan(\text{yaw})=\frac{x}{z}
$$

最终我们就得到了 pitch 和 yaw 的值，到此整个流程就全部结束了~

## 效果展示

{% include embed/video.html src='/assets/video/2024-09-18-46环的秘密-解算与拟合篇/showcase.mp4' %}

## 相关代码

哈尔滨工业大学 2023 年能量机关识别代码：[https://github.com/zmsbruce/rm_power_rune](https://github.com/zmsbruce/rm_power_rune)
