---
title: 46 环的秘密—滤波篇
data: 2024-10-06 22:32:44 +0800
categories: [RoboMaster, 能量机关]
tags: [RoboMaster, 卡尔曼滤波, 能量机关]
math: true
description: 能量机关参数滤波详解
author: young-x
---

## 最小二乘的问题

书接上回，对于角度数据的拟合，我们采用了最小二乘法结合 RANSAC 对角度信息进行处理。但这种方法实质上是一种批量方法 (Batch Least Squard)，且使用的数据是经过打乱后的全局数据。这种处理方法可能会导致在角度变化平缓或陡峭处出现“过拟合”的问题，如下图。

![](/assets/img/2024-10-06-46环的秘密-滤波篇/unuse.jpg)  

我们可以看到，在 2.5s 左右（角速度较小时）出现过拟合情况（拟合曲线仍按原先趋势上升）。这种情况可能由以下原因导致：

1. RANSAC 在处理数据时，将全局数据打乱后作为整体进行处理（无时序），没有考虑到前后数据之间的关联性。  
2. 最小二乘法在处理数据时，在拟合线程中一次性对多个数据进行拟合，在每次拟合时都没有考虑前一时刻的状态，可能导致拟合曲线出现“波动”现象。

以上问题迫切需要我们引用一种能够使用时序数据，且在每次拟合时考虑前一时刻状态的方法——即卡尔曼滤波。

## Kalman 滤波

卡尔曼滤波是一种递归的参数估计方法，它能够根据前一时刻的状态估计当前时刻的状态，且具有最优估计性质。下面简单介绍一下卡尔曼基础知识。

卡尔曼滤波分为两个部分：预测和更新。  

### 预测

卡尔曼滤波的预测部分可以看作是一个线性回归问题，其预测方程为：

$$
\hat{x}_{k+1} = F_k \hat{x}_k + B_k u_k + w_k
$$

### 更新

卡尔曼滤波的更新部分可以看作是一个加权平均问题，其更新方程为：  

$$
\hat{x}_{k+1} = \hat{x}_{k+1} + K_k (z_k - \hat{z}_{k+1})
$$  

其中，$K_k$为卡尔曼增益。  

而对非线性系统而言，卡尔曼滤波的预测和更新方程需要经过线性化处理（即对其运动模型 f，观测模型 h 进行线性化）。线性化的本质就是一个函数在固定点的泰勒展开，并保留一阶系数。如果对一个普通的矢量函数在$x_0$进行线性化，可以得到： 

$$
f(x)=f(x_0)+J(x_0)(x-x_0) +\frac{1}{2}H(x_0)(x-x_0)^{'}(x-x_0)+\cdots
$$  

其中，$J(x_0)$为雅可比矩阵，$H(x_0)$为海森矩阵。是线性化中最重要的部分，其决定了线性化后方程的精度。若只保留一阶系数，则线性化方程可表示为：  

$$
f(x)=f(x_0)+J(x_0)(x-x_0)
$$  

可以对非线性系统的运动方程和观测方程进行线性化处理，然后将卡尔曼滤波器的结论应用于非线性系统，即可得到拓展卡尔曼滤波(EKF)。

卡尔曼滤波的推导过程有较多资料，这里不再赘述。（推荐阅读 Timothy D.Barfoot 的《机器人学中的状态估计》）。 

总的来说，卡尔曼滤波是一种基于马尔科夫过程的增量式方法，能够利用上一时刻的状态估计当前时刻的状态，保证了数据间的关联性，且其也具有最优估计性质。  

由于角度拟合问题为一个非线性优化问题，我们首先考虑单独使用拓展卡尔曼滤波 (EKF) 对旋转角度进行预测是否可行。  

解算与拟合篇中已经推导出我们需要拟合的角度时间函数：

$$
\text{angle}(t)=\int\text{spd(t)}\, dt=-\frac{a}{\omega}\cos(\omega t+t_0)+b\cdot t+c
$$  

简化形式：

$$
\text{angle}(t)=A\cos(\omega t+t_0)+b\cdot t+c
$$  

同样地，我们亦可利用该函数作为我们EKF中的运动模型（预测方程）。由该方程我们不难倒推出我们需要的状态量—— angle、A、omega、t0、b、c。  

离散化后，我们的运动模型可以表示为：

$$
\text{angle}(k)=\text{angle}(k-1)(A\cos(\omega t+t_0)+b\cdot t+c)^{'}\Delta t
$$  

状态转移矩阵为：  

$$
\begin{bmatrix}
1 & M \cdot m_{\text{deltaTime}} & N \cdot m_{\text{Time}} \cdot m_{\text{deltaTime}} & N \cdot m_{\text{deltaTime}} & m_{\text{Time}} \cdot m_{\text{deltaTime}} & m_{\text{deltaTime}} \\
0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 1
\end{bmatrix}
$$

其中，$M=\cos(\omega t+t_0)$，$N=-A\omega\sin(\omega t+t_0)$.

由于我们可观测的数据仅有角度，故观测维度为 1。  
综上所述，我们可以设置调节参数为：过程噪声协方差矩阵 Q、观测噪声协方差矩阵 R、初始状态协方差矩阵 P。通过调节上述三种协方差的值来获得效果最好的拟合参数。 

虽然 EKF 能够利用上一时刻的状态估计当前时刻的状态，但EKF在处理非线性问题时，其预测方程和更新方程均为线性化后的方程，因此其预测结果可能存在误差，由于运动模型建模得十分粗糙（在状态转移矩阵中，笔者直接将除了角度以外的其他参数假设为不变的值。但或许状态量之间有着一定联系），因此预测效果并不理想，且调参工作量巨大，故该方案后续被搁置，留待后人继续探索。

![](/assets/img/2024-10-06-46环的秘密-滤波篇/EKF.png)

## 预测准确性与数据关联性的折衷

在 EKF 方案被搁置后，我们开始思考如何利用卡尔曼滤波解决角度拟合问题。既然实践证明 EKF 拟合效果不如最小二乘法，那么我们是否可以尝试将卡尔曼滤波与最小二乘法相结合，以获得更好的拟合效果呢？ 

我们首先思考一下卡尔曼滤波与最小二乘法的区别。

最小二乘法是一种批量方法，其每次拟合时都考虑全局数据，因此其具有较好的关联性，但无法利用时序数据，且在拟合过程中无法实时获取当前状态。  

卡尔曼滤波是一种增量式方法，其每次拟合时只考虑当前时刻的数据，因此其无法利用全局数据，但能够利用时序数据，且在拟合过程中能够实时获取当前状态。 

因此，我们可以尝试将卡尔曼滤波与最小二乘法相结合，以获得更好的拟合效果。具体来说，我们可以将卡尔曼滤波作为最小二乘法的优化器，即每次拟合时，首先利用卡尔曼滤波预测当前时刻的状态，然后将该状态作为最小二乘法的初始值，最后利用最小二乘法对当前时刻的数据进行拟合。  

通过上车实测，我们发现该方案能够有效提高拟合效果，且具有较好的数据关联性，在一定程度上减小了“过拟合”问题的发生概率(文章开始时的数据，但使用 KF 进行拟合后，在 2.5s 左右（角速度较小时）的过拟合现象得到了有效缓解)

![](/assets/img/2024-10-06-46环的秘密-滤波篇/useKF.jpg)  
